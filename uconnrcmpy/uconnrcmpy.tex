% !TEX option = -shell-escape
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This work is licensed under the Creative Commons Attribution 4.0
% International License. To view a copy of this license, visit
% http://creativecommons.org/licenses/by/4.0/.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[12pt]{../ussci}

\usepackage{enumitem}
\setlist{noitemsep}

\usepackage{siunitx}
\usepackage{graphicx}
\usepackage{mathtools}
\usepackage{microtype}

% Fix missing mu character from a reference
\usepackage{textcomp}
\DeclareUnicodeCharacter{3BC}{\textmu}
\DeclareUnicodeCharacter{39C}{\textmu}

\usepackage[capitalize]{cleveref}
%======================================================================
\addbibresource[location=remote]{http://localhost:23119/better-bibtex/collection?/0/2017-National-Combustion-Meeting/UConnRCMPy.biblatex}
%======================================================================
\newcommand\papertopic{Reaction Kinetics}
%======================================================================
\DeclareSIUnit\torr{torr}

\title{ UConnRCMPy: Python-based data analysis for Rapid Compression Machines }

\author[1*]{Bryan W.\ Weber}
\author[1]{Chih-Jen Sung}
\affil[1]{Department of Mechanical Engineering, University of Connecticut, Storrs,
CT, USA}
\affil[*]{Corresponding Author: \email{bryan.weber@uconn.edu}}

\begin{document}
\maketitle

%====================================================================
\begin{abstract} % not to exceed 200 words
    The ignition delay of a fuel/air mixture is an important quantity in
    designing combustion devices, and these data are also used to validate
    computational kinetic models for combustion. One of the typical
    experimental devices used to measure the ignition delay is called a
    Rapid Compression Machine (RCM). This paper presents UConnRCMPy, an
    open-source Python package to process experimental data from the RCM at
    the University of Connecticut. Given an experimental measurement,
    UConnRCMPy computes the thermodynamic conditions in the reaction chamber
    of the RCM during an experiment along with the ignition delay.
    UConnRCMPy relies on several packages from the SciPy stack and the
    broader scientific Python community. UConnRCMPy implements an extensible
    framework, so that alternative experimental data formats can be
    incorporated easily. In this way, UConnRCMPy improves the consistency of
    RCM data processing and enables reproducible analysis of the data.
\end{abstract}

% (Provide 2-4 keywords describing your research. Only abbreviations firmly
% established in the field may be used. These keywords will be used for
% sessioning/indexing purposes.)
\begin{keyword}
    chemical kinetics\sep rapid compression machine\sep reproducibility
\end{keyword}

\section{Introduction}\label{introduction}

Producing research outputs that can be reproduced by future scientists is one of
the fundamental tenents of our present scientific methodology. In recent years,
there has been a surge in interest in ensuring that research outputs are
reproducible \autocite{NatureEds2016}. Recognizing that the code used to process
experimental data is an important part of the chain, this paper presents the
design and operation of a software package to process the pressure data
collected from Rapid Compression Machines (RCMs). Our package, called UConnRCMPy
\autocite{uconnrcmpy}, is designed to analyze the data acquired from the RCM at
the University of Connecticut (UConn). Despite the initial focus on data from
the UConn RCM, the package is designed to be extensible so that it can be used
for data in different formats while providing a consistent interface to the
user. Thus, UConnRCMPy offers all of the features required to process standard
RCM data including:

\begin{itemize}
\item
  Filtering and smoothing the raw voltage generated by the pressure
  transducer
\item
  Converting the voltage trace into a pressure trace using settings
  recorded from the RCM
\item
  Processing the pressure trace to determine parameters of interest in
  reporting the experiments, including the ignition delay and
  machine-specific effects on the experiment
\item
  Conducting simulations utilizing the experimental information to
  calculate the temperature during the experiment
\end{itemize}

Previous software used to analyze RCM data has generally been
undocumented and untested code specific to the researcher conducting the
experiments. Moreover, the software typically used to estimate the
temperature in the experiments is difficult to integrate with the data
processing code. To the best of the authors' knowledge, UConnRCMPy is
the first package for analysis of standard RCM data to be presented in
detail in the literature, and it tightly integrates the temperature
estimation routine into the workflow, reducing errors and
inefficiencies.

\section{RCM Signal Processing Procedure}\label{rcm-signal-processing-procedure}

The RCMs at the University of Connecticut have been described extensively
elsewhere \autocite{Das2012,Mittal2007a}, and interested readers are referred to
those papers for further details. The primary diagnostic on the RCM is the
reaction chamber pressure during and after the compression process, measured by
a dynamic pressure transducer. The pressure trace is processed to determine the
quantities of interest, including the pressure and temperature at the EOC,
\(P_C\) and \(T_C\) respectively, and the ignition delay, \(\tau\). These values
depend on the pressure and temperature prior to the start of compression
(\(P_0\) and \(T_0\), respectively), in addition to the composition of the
reactant mixture. A single compression-delay-ignition sequence is
referred to as an experiment or a run and a set of experiments at a given
\(P_C\) and mixture composition is referred to as a condition.

The dynamic pressure transducer outputs a charge signal that is converted to a
voltage signal by a charge amplifier with a nominal output of \SI{0}{\V}. In
addition, the output range of \SIrange{0}{10}{\V} is set by the operator to
correspond to a particular pressure range by setting a ``scale factor''. The
voltage output from the charge amplifier is digitized by a hardware data
acquisition system (DAQ) and recorded into a plain text file by a LabView
Virtual Instrument. \Cref{fig:raw-voltage} shows a typical voltage trace
measured from the RCM at UConn and demonstrates the typical noise in the signal,
which requires filtering and further processing to produce a useful pressure
trace.

\begin{figure}[htbp]
    \begin{minipage}[t]{0.48\textwidth}
        \centering
        \includegraphics[width=\linewidth]{figures/raw-voltage.pdf}
        \caption{Raw voltage trace and the voltage trace after filtering from a typical
        RCM experiment. (a): Close up of the
        time around the EOC (b): Close up of the time before the start of
        compression}
        \label{fig:raw-voltage}
    \end{minipage}\hfill%
    \begin{minipage}[t]{0.48\textwidth}
        \centering
        \includegraphics[width=\linewidth]{figures/residuals.pdf}
        \caption{Root mean squared residuals of the filtered signal compared to the
        original signal for a range of filter cutoff frequencies}
        \label{fig:residuals}
    \end{minipage}
\end{figure}

In the current version of UConnRCMPy \autocite{uconnrcmpy}, the voltage is
filtered using a first-order Butterworth filter. The cutoff frequency of the
filter is chosen automatically by a procedure described in the work of
\textcite{Yu1999,Duarte2014}. Briefly, this procedure applies low-pass filters
of varying cutoff frequencies to the signal and calculates the root mean square
residual between the filtered signal and the original signal.
\Cref{fig:residuals} shows a typical plot of the residuals versus the cutoff
frequency and demonstrates that the residuals are nearly linear for a range of
cutoff frequencies. This range tends to start at one-twentieth the Nyquist
frequency but the end point is variable. Therefore, a series of linear
regressions are performed as the end point is shifted from one-half the Nyquist
frequency to one-tenth the Nyquist frequency. Then, the $y$-intercept of the
regression with the highest coefficient of determination is used to choose the
optimal cutoff frequency. The optimum cutoff frequency is chosen as the
frequency at the intersection of the $y$-intercept and the residuals curve. The
result of the filtering operation is shown on \cref{fig:raw-voltage}.

After filtering, the voltage trace is converted to a pressure trace by
correcting for the offset from the nominal initial volage of \SI{0}{\V} apparent
in \mbox{\cref{fig:raw-voltage}b}, multiplying the voltage by the scale factor
from the charge amplifier, and adding the initial pressure \(P_0\). The result
is a vector of pressure values that must be further processed to determine the
time of the EOC and the ignition delay.

Once the pressure trace has been constructed, the EOC pressure and temperature
and the ignition delay can be calculated. In the current version of UConnRCMPy
\autocite{uconnrcmpy}, the time of the EOC is determined by finding the local
maximum of the pressure prior to ignition. This is done by searching backwards
in time from the global maximum pressure in the pressure trace (typically, the
global maximum of the pressure is due to ignition) until a minimum in the
pressure is reached. The maximum of the pressure in points to the left of the
minimum is defined as the EOC. The value of the pressure at the EOC, \(P_C\), is
recorded and the time at the EOC is taken to be \(t=\SI{0}{\s}\).

Then, the ignition delay is determined as the time difference between the EOC
and the point of ignition, defined as the inflection point in the pressure
trace due to ignition. The inflection point is found by the maximum
of the first derivative of the pressure with respect to time.
In the current version of UConnRCMPy \autocite{uconnrcmpy}, the first
derivative of the experimental pressure trace is computed by a
second-order forward differencing method. The derivative is then
smoothed by a moving average algorithm with a width of 151 points.
This value for the moving average window was chosen empirically.

For some conditions, the reactants may undergo two distinct stages of
ignition. These cases can be distinguished by a pair of peaks in the
first time derivative of the pressure. For some two-stage ignition
cases, the first-stage pressure rise, and consequently the peak in the
derivative, are relatively weak, making it hard to distinguish the peak
due to ignition from the background noise. This is currently the area
requiring the most manual intervention, and one area where significant
improvements can be made by refining the differentiation and
filtering algorithms. An experiment that shows two clear peaks
in the derivative is shown in \cref{fig:ign-delay-def} to
demonstrate the definition of the ignition delays.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.6\textwidth]{figures/ign-delay-def.pdf}
    \caption{Illustration of the definition of the ignition delay in a
    two-stage ignition case}
    \label{fig:ign-delay-def}
\end{figure}

The final parameter of interest presently is the EOC temperature,
\(T_C\). This temperature is often used as the reference temperature
when reporting ignition delays. In general, it is difficult to measure
the temperature as a function of time in the reaction chamber of the
RCM, so methods to estimate the temperature from the pressure trace are
used. The detailed procedure used in UConnRCMPy is described in the work
of \textcite{Dames2016}, and an overview is given here.

In general, the temperature in the RCM reaction chamber as a function of
time can be found by integrating the first law of thermodynamics for an
ideal gas:
%
\begin{equation} \label{eq:first-law}
    c_v \frac{dT}{dt} = -P \frac{dv}{dt} - \sum_k u_k \frac{d Y_k}{dt}
\end{equation}
%
where \(c_v\) is the specific heat at constant volume of the mixture,
\(v\) is the specific volume, \(u_k\) and \(Y_k\) are the specific
internal energy and mass fraction of the species \(k\), and \(t\) is
time. In UConnRCMPy, \cref{eq:first-law} is integrated by Cantera
\autocite{cantera}.

Integrating \cref{eq:first-law} requires knowledge of the volume of the reaction
chamber as a function of time. To calculate the volume as a function of time, it
is assumed that there is a core of gas in the reaction chamber that undergoes an
isentropic, constant composition compression \autocite{Lee1998}. The initial
entropy of the gas mixture is calculated using Cantera \autocite{cantera}.
Subsequently, the state of the mixture is fixed by using the entropy and
measured pressure; from this information, the volume is calculated. The initial
volume is arbitrarily taken to be \(V_0=\SI{1.0}{\m\cubed}\). The initial volume
used in constructing the volume trace is arbitrary provided that the same value
is used for the initial volume in the simulations described below. However,
extensive quantities such as the total heat release during ignition cannot be
compared to experimental values.

Two simulations can be triggered by the user that solve \cref{eq:first-law}. In
the first, the multiplier for all the reaction rates is set to zero, to simulate
a constant composition (non-reactive) process. In the second, the reactions are
allowed to proceed as normal. Only the non-reactive simulation is necessary to
determine \(T_C\), which is defined as the simulated temperature at the EOC
time.

When a reactive simulation is conducted, the user must compare the
temperature traces from the two simulations to verify that the inclusion
of the reactions does not change \(T_C\), validating the assumption of
adiabatic, constant composition compression. Although including
reactions during the compression stroke does not affect the value of
\(T_C\), it does allow for the buildup of a small pool of radicals that
can affect processes after the EOC \autocite{Mittal2008}. Thus, it is
critical to include reactions during the compression stroke when
conducting simulations to compare a kinetic model to experimental
results.

As can be seen in \cref{fig:ign-delay-def}, the pressure
decreases after the EOC due to heat transfer from the higher temperature
reactants to the reaction chamber walls. This process is specific to the
machine that carried out the experiments, and to the conditions under
which the experiment was conducted. To include the effect of this heat
transfer into simulations, a non-reactive experiment is conducted, where
\(\text{O}_2\) in the oxidizer is replaced with \(\text{N}_2\).

To apply the effect of the post-compression heat loss into the simulations, the
reaction chamber is modeled as undergoing an adiabatic volume expansion after
EOC. Since the post-compression time is modeled as an isentropic expansion, the
same procedure is used as in the computation of \(T_C\) to compute a volume
trace for the post-EOC time. The only difference is that the non-reactive
pressure trace is used after the EOC instead of the reactive pressure trace.
This procedure has been validated experimentally by measuring the temperature in
the reaction chamber during and after the compression stroke. The temperature of
the reactants was found to be within $\pm\sim $\SI{5}{\K} of the simulated
temperature \autocite{Das2012a,Uddi2012}.

\section{Implementation and Usage of UConnRCMPy}\label{implementation-and-usage-of-uconnrcmpy}

UConnRCMPy is constructed in a hierarchical manner. The main user interface to
UConnRCMPy is through the \python|Condition| class, the highest level of data
representation. The \python|Condition| class contains all of the information
pertaining to the experiments at a given condition. The intended use of this
class is in an interactive Python interpreter (the author prefers the Jupyter
Notebook with an IPython kernel \autocite{Perez2007}). First, the user creates
an instance of the \python|Condition| class.

\begin{minted}{python}
from uconnrcmpy import Condition
%matplotlib qt5

cond_00_02 = Condition(cti_file='./species.cti')
\end{minted}

The \python|cti_file| argument to \python|Condition| must point to a file in the
CTI format that contains the thermodynamic and reaction information for the
species in the mixture. The experiments in the following example were conducted
with mixtures of propane, oxygen, and nitrogen \autocite{Dames2016}. The CTI
file necessary to run this example can be found in the Supplementary Material of
the work by \textcite{Dames2016}. Then, the composition of the mixture under
consideration must be added to the \python|initial_state| parameter of the
\python|ideal_gas()| function in the CTI file:

\begin{minted}{python}
ideal_gas(
    name='gas', elements=..., species=..., reactions='all',
    initial_state=state(mole_fractions='C3H8:0.0403,O2:0.1008,N2:0.8589'))
\end{minted}

Ellipses indicate input that was truncated to save space; the truncated input is
present in the file available with the work of \textcite{Dames2016}. The
\python|mole_fractions| must be set to the appropriate values. The condition in
this example is for a fuel rich mixture, with a target \(P_C\) of 30 bar.

After initializing the \python|Condition|, the user conducts a reactive
experiment with the RCM and adds the experiment to the \python|Condition| using
the \python|add_experiment()| method. As each experiment is processed by
UConnRCMPy, the information from that run is added to the system clipboard for
pasting into some spreadsheet software. In the current version, the information
copied is the time of day of the experiment, the initial pressure, the initial
temperature, the pressure at the EOC, the overall and first stage ignition
delays, an estimate of the EOC temperature, some information about the
compression ratio of the reactor, and the filter frequnecy used.

\begin{minted}{python}
# Conduct reactive experiment #1 on the RCM
cond_00_02.add_experiment('00_in_02_mm_373K-1282t-100x-19-Jul-15-1633.txt')
# ... add other reactive experiments
\end{minted}

In general, for a given condition, the user will conduct and process all
of the reactive experiments before conducting any non-reactive
experiments. Then, the user chooses one of the reactive experiments as
the reference experiment for the condition (i.e., the one whose ignition
delay(s) and \(T_C\) are reported) by inspection of the data in the
spreadsheet. The reference experiment is defined as the experimental run
whose overall ignition delay is closest to the mean overall ignition
delay among the experiments at a given condition. To select the
reference experiment, the user sets the \python|reactive_file|
attribute of the \python|Condition| instance. For this case, the
reference experiment is the run that took place at 16:33:

\begin{minted}{python}
cond_00_02.reactive_file = '00_in_02_mm_373K-1282t-100x-19-Jul-15-1633.txt'
\end{minted}

If the user does not specify the \python|reactive_file| attribute,
they are prompted for the file name when the first non-reactive case is added.
Once the reference reactive experiment is selected, the user runs non-reactive
experiments at the same initial conditions as the reference experiment. The user
adds non-reactive experiments to the \python|Condition| by the same
\python|add_experiment()| method and UConnRCMPy automatically
determines whether the experiment is reactive or non-reactive.

\begin{minted}{python}
# Conduct non-reactive experiment #1 on the RCM
cond_00_02.add_experiment('NR_00_in_02_mm_373K-1278t-100x-19-Jul-15-1652.txt')
\end{minted}

UConnRCMPy determines that this is a non-reactive experiment and
generates a new figure that compares the current non-reactive case with
the reference reactive case. For this particular example, the pressure traces
are shown in \cref{fig:ign-delay-def}. In this case, the non-reactive
pressure agrees very well with the reactive pressure and no further
experiments are necessary; in principle, any number of non-reactive
experiments can be conducted and added to the figure for comparison.
Since there is good agreement between the non-reactive and reactive
pressure traces, the user sets the \python|nonreactive_file| attribute of the
\python|Condition| instance.

\begin{minted}{python}
cond_00_02.nonreactive_file = 'NR_00_in_02_mm_373K-1278t-100x-19-Jul-15-1652.txt'
\end{minted}

Once the non-reactive case is chosen, the \python|create_volume_trace()| method
can be run. This method requires three attributes to be set on the
\python|Condition| instance: \python|nonreactive_end_time|,
\python|reactive_end_time|, and \python|reactive_compression_time|. The value of
\python|nonreactive_end_time| controls the end time for volume trace generation,
the value of \python|reactive_end_time| controls the length of the pressure
trace stored in the output file, and the \python|reactive_compression_time| is
the length of the compression stroke. All of the values must be supplied in
units of milliseconds. After generating the volume trace,
\python|create_volume_trace()| writes the \python|volume.csv| file, the pressure
trace file, and a file called \python|volume-trace.yaml|, which contains the
values that were set for each attribute.

The final step to conduct the simulations to calculate \(T_C\) and the simulated
ignition delay. This is done by the user by running the
\python|compare_to_sim()| function. This function takes two optional arguments,
\python|run_reactive| and \python|run_nonreactive|. These determine which
type(s) of simulation(s) should be conducted.

\begin{minted}{python}
cond_00_02.create_volume_trace()
cond_00_02.compare_to_sim(run_reactive=True, run_nonreactive=True)
\end{minted}

% The general flow of the user interaction with UConnRCMPy is shown in
% \cref{fig:flowchart}. The Inputs are required input from the
% user, while the User Interface are classes and functions called by the
% user during processing.

UConnRCMPy is documented using standard Python docstrings for functions and
classes. The documentation is converted to HTML files by the Sphinx
documentation generator \autocite{Brandl2016}. The format of the docstrings
conforms to the NumPy docstring format so that the autodoc module of Sphinx can
be used. The documentation is available on the web at
\href{https://bryanwweber.github.io/UConnRCMPy/}. UConnRCMPy also relies heavily
on functionality from the NumPy \autocite{vanderWalt2011}, SciPy
\autocite{Jones2001}, and Matplotlib \autocite{Hunter2007} Python packages.

% \begin{figure}[htbp]
%     \centering
%     \includegraphics[width=0.75\textwidth]{figures/flowchart.pdf}
%     \caption{Flowchart of information in \mbox{UConnRCMPy}}
%     \label{fig:flowchart}
% \end{figure}

\section{Conclusions and Future Work}\label{conclusions-and-future-work}

UConnRCMPy provides a framework to enable consistent analysis of RCM
data. Because it is open source and extensible, UConnRCMPy can help to
ensure that RCM data in the community can be analyzed in a reproducible
manner; in addition, it can be easily modified and used for data in any
format. In this sense, UConnRCMPy can be used more generally to process
any RCM experiments where the ignition delay is the primary output.

Future plans for UConnRCMPy include the development of a robust test suite to
prevent regressions and document correct usage of the framework, as well as the
development of a plugin architechture to allow easy implementation of
user-defined analysis features. Other issues and directions are listed in the
Issue page of the GitHub repository
\href{https://github.com/bryanwweber/uconnrcmpy/issues/}.

\section{Acknowledgements}\label{acknowledgements}

This paper is based on material supported by the National Science
Foundation under Grant No. CBET-1402231.

\printbibliography

\end{document}
